name: m8c macos arm64 build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
     
  build-macos:
    runs-on: macos-latest
    name: m8c MacOS build (Apple Silicon)
    env:
      BUILD_DIR: build-arm64
    
    steps:
      - name: 'Environment info'
        run: |
          uname -m
    
      - name: 'Install dependencies'
        run: brew update && brew install cmake pkg-config sdl3 libserialport
          
      - name: 'Checkout'
        uses: actions/checkout@v4

      - name: Set current date as env variable
        run: echo "NOW=$(date +'%Y-%m-%d')" >> $GITHUB_ENV


      - name: 'Configure m8c'
        id: configureApplication
        run: |
          mkdir -p ${{ env.BUILD_DIR }}
          pushd ${{ env.BUILD_DIR }}
          cmake .. -DCMAKE_BUILD_TYPE=Release -DMACOS_CODE_SIGN_IDENTITY="$MACOS_CODE_SIGN_IDENTITY"
          popd
        env:
          MACOS_CODE_SIGN_IDENTITY: 'Apple Development: ${{ secrets.APPLE_ID }} (${{ secrets.TEAM_ID }})'

      - name: 'Build and package m8c'
        id: buildApplication
        continue-on-error: true
        run: |
          pushd ${{ env.BUILD_DIR }}
          cpack -V .
          popd
        env:
          CMAKE_INSTALL_PREFIX: build_output

      - name: 'View debug log if compilation fails'
        if: failure() && steps.buildApplication.outcome == 'failure'
        run: cat /Users/runner/work/m8c/m8c/${{ env.BUILD_DIR }}/_CPack_Packages/Darwin/DragNDrop/PreinstallOutput.log



      - name: Delete Custom Keychain
        if: always()
        run: |
          security delete-keychain build.keychain

      - name: 'Copy package'
        run: |
          APP_PATH=$(find build_output -name "*.dmg" | head -n 1)
          mv "$APP_PATH" m8c-${{ env.NOW }}-macos-applesilicon.dmg

      - name: 'Upload DMG package'
        uses: actions/upload-artifact@v4
        with:
          name: m8c-${{ env.NOW }}-macos-applesilicon
          path: |
            m8c-${{ env.NOW }}-macos-applesilicon.dmg
